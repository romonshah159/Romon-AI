<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Romon AI - Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { background-color: #131314; color: #e3e3e3; height: 100vh; display: flex; flex-direction: column; font-family: 'Inter', 'Segoe UI', sans-serif; margin: 0; overflow: hidden; }
        .navbar { background-color: #131314; border-bottom: 1px solid #2b2c2f; padding: 10px 0; flex-shrink: 0; }
        .nav-container { display: flex; align-items: center; width: 100%; padding: 0 15px; }
        .navbar-toggler, .navbar-toggler:focus, .navbar-toggler:active { border: none !important; color: #9aa0a6; font-size: 18px; background: transparent; margin-right: 15px; box-shadow: none !important; outline: none !important; }
        .navbar-brand { font-weight: bold; font-size: 1.25rem; margin-right: auto; color: white !important; text-decoration: none; }
        .offcanvas { background-color: #171717 !important; color: #e3e3e3; width: 300px !important; border-right: 1px solid #2b2c2f; }
        .offcanvas-header { padding: 15px; border-bottom: 1px solid #2b2c2f; }
        .offcanvas-title { font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; }
        .offcanvas-body { padding: 10px 8px; display: flex; flex-direction: column; overflow: hidden; font-size: 15px; }
        .menu-label { font-size: 10px; font-weight: 700; color: #5f6368; text-transform: uppercase; margin: 12px 0 6px 8px; display: block; letter-spacing: 1px; }
        .hr-divider { border: 0; border-top: 1px solid rgba(255,255,255,0.05); margin: 10px 0; }
        .new-chat-btn { background: #373e4a93; color: white; border-radius: 10px; padding: 10px; text-align: center; cursor: pointer; margin: 5px; font-weight: 600; font-size: 14px; transition: 0.2s; }
        .new-chat-btn:hover { background: #39404bf2; }
        .lang-card { background: #202123; border-radius: 10px; padding: 8px 12px; border: 1px solid #2b2c2f; display: flex; align-items: center; justify-content: space-between; margin: 0 5px; }
        .lang-text { font-size: 13px; font-weight: 500; color: #bdc1c6; }
        .switch { position: relative; width: 32px; height: 16px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #3c4043; transition: .3s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 10px; width: 10px; left: 3px; bottom: 3px; background-color: #fff; transition: .3s; border-radius: 50%; }
        input:checked + .slider { background-color: #8ab4f8; }
        input:checked + .slider:before { transform: translateX(16px); }
        .history-section { flex-grow: 1; overflow-y: auto; margin-bottom: 5px; max-height: 40vh; }
        .history-item { display: flex; align-items: center; padding: 10px; border-radius: 8px; cursor: pointer; margin-bottom: 2px; transition: 0.2s; }
        .history-item:hover { background: #202123; }
        .history-text { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 14px; color: #bdc1c6; flex-grow: 1; }
        .history-delete { color: #5f6368; font-size: 13px; padding: 5px; transition: 0.2s; }
        .history-delete:hover { color: #ff4d4d; transform: scale(1.1); }
        .empty-history { text-align: center; padding: 20px; color: #5f6368; }
        .empty-history i { font-size: 30px; margin-bottom: 10px; display: block; }
        .ai-nav-item { display: flex; align-items: center; padding: 10px; border-radius: 8px; color: #bdc1c6; text-decoration: none; font-size: 14px; margin-bottom: 1px; transition: 0.2s; }
        .ai-nav-item:hover { background: #2021237f; color: white; }
        .ai-nav-item.active { background: #202123; color: white; }
        .model-icon { width: 18px; height: 18px; margin-right: 12px; border-radius: 4px; object-fit: contain; }
        .sidebar-footer { border-top: 1px solid #2b2c2f; padding: 10px; display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
        .user-avatar { width: 28px; height: 28px; background: #3c4043; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #8ab4f8; font-size: 11px; }
        .user-info { font-size: 12px; color: #e3e3e3; }
        #chat-container { flex: 1; overflow-y: auto; padding: 20px; max-width: 900px; margin: 0 auto; width: 100%; display: flex; flex-direction: column; scroll-behavior: smooth; }
        .user-message-wrapper { align-self: flex-end; max-width: 85%; background-color: #2b2c2f; padding: 12px 20px; border-radius: 20px 20px 4px 20px; margin-bottom: 25px; color: white; white-space: pre-wrap; font-size: 16px; position: relative; }
        .ai-message-wrapper { align-self: flex-start; width: 100%; margin-bottom: 35px; }
        .ai-name { font-weight: bold; margin-bottom: 10px; display: block; font-size: 15px; }
        .ai-content { font-size: 18px; line-height: 1.6; color: #e3e3e3; font-weight: 500; }
        .loading-container { display: flex; align-items: center; gap: 12px; }
        .loading-logo-wrapper { position: relative; width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; }
        .loading-logo { width: 20px; height: 20px; object-fit: contain; position: relative; z-index: 2; border-radius: 50%; animation: logoPulse 2s ease-in-out infinite; }
        .loading-spinner { position: absolute; width: 100%; height: 100%; border: 2.5px solid rgba(255,255,255,0.1); border-top-color: #4285f4; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes logoPulse { 0% { transform: scale(0.85); opacity: 0.7; } 50% { transform: scale(1.05); opacity: 1; } 100% { transform: scale(0.85); opacity: 0.7; } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .pulse-text { animation: pulse 1.5s infinite; font-size: 14px; color: #888; }
        .input-area { padding: 20px; max-width: 800px; margin: 0 auto; width: 100%; background: #131314; flex-shrink: 0; }
        .input-box-wrapper { background-color: #1e1f20; border-radius: 25px; padding: 5px 20px; display: flex; align-items: flex-end; border: 1px solid #444; }
        .input-box-wrapper textarea { background: transparent; border: none; color: white; outline: none; width: 100%; padding: 10px; font-size: 16px; resize: none; max-height: 150px; }
        .clr-romon { color: #fff; } .clr-gemini { color: #4285f4; } .clr-chatgpt { color: #10a37f; } .clr-deepseek { color: #60a5fa; }

        /* Fullscreen Ad Box Style */
        #unlock-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 10000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
        }
        .unlock-card {
            background: #1e1f20;
            padding: 30px;
            border-radius: 20px;
            border: 1px solid #333;
            max-width: 450px;
            width: 100%;
        }
        .unlock-title { font-size: 20px; font-weight: bold; margin-bottom: 15px; color: #fff; }
        .unlock-desc { font-size: 14px; color: #bdc1c6; margin-bottom: 25px; }
        .unlock-btn {
            background: #4285f4;
            color: #fff;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            transition: 0.3s;
        }
        .unlock-btn:hover { background: #3367d6; }
        #ad-close-btn {
            display: none;
            margin-top: 15px;
            background: #3c4043;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="unlock-overlay">
        <div class="unlock-card">
            <div class="unlock-title">পরবর্তি ১২ ঘণ্টা চ্যাট করার জন্য আনলক করুন</div>
            <div class="unlock-desc">আমাদের সার্ভিসটি ফ্রি রাখার জন্য একটি ছোট বিজ্ঞাপন দেখুন। আনলক বাটনে ক্লিক করে ৫ সেকেন্ড অপেক্ষা করুন।</div>
            <a href="https://otieu.com/4/10582847" target="_blank" class="unlock-btn" id="mentag-link" onclick="startAdProcess()">Unlock Now</a>
            <div id="timer-display" style="margin-top: 15px; color: #8ab4f8; font-weight: bold;"></div>
            <button id="ad-close-btn" onclick="completeUnlock()">Close</button>
        </div>
    </div>

    <nav class="navbar navbar-dark">
        <div class="nav-container">
            <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu"><i class="fas fa-bars"></i></button>
            <a class="navbar-brand" href="#">Romon AI</a>
            <button class="btn btn-outline-light btn-sm rounded-pill px-3" id="loginBtn" onclick="handleLoginAction()">Login</button>
        </div>
    </nav>

    <div class="offcanvas offcanvas-start" id="sidebarMenu">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title">
                <img src="Romon-AI.png" class="model-icon"> Romon AI
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" style="font-size: 9px;"></button>
        </div>
        
        <div class="offcanvas-body">
            <div class="new-chat-btn" onclick="createNewChat()" id="newChatBtn">
                <i class="fas fa-plus me-1"></i> New chat
            </div>

            <span class="menu-label" id="aiLabel">Models Engine</span>
            <nav class="nav flex-column mb-2" id="ai-list">
                <a class="ai-nav-item active" href="#" onclick="selectAI('Romon AI', 'clr-romon', 'Romon-AI.png', this)">
                    <img src="Romon-AI.png" class="model-icon">Romon AI
                </a>
                <a class="ai-nav-item" href="#" onclick="selectAI('Gemini 1.5', 'clr-gemini', 'https://uxwing.com/wp-content/themes/uxwing/download/brands-and-social-media/google-gemini-icon.png', this)">
                    <img src="https://uxwing.com/wp-content/themes/uxwing/download/brands-and-social-media/google-gemini-icon.png" class="model-icon">Gemini 1.5
                </a>
                <a class="ai-nav-item" href="#" onclick="selectAI('ChatGPT-4o', 'clr-chatgpt', 'ChatGPT.png', this)">
                    <img src="ChatGPT.png" class="model-icon">ChatGPT-4o
                </a>
                <a class="ai-nav-item" href="#" onclick="selectAI('DeepSeek R1', 'clr-deepseek','https://www.deepseek.com/favicon.ico', this)">
                    <img src="https://www.deepseek.com/favicon.ico" class="model-icon">DeepSeek R1
                </a>
            </nav>

            <hr class="hr-divider">

            <span class="menu-label" id="historyLabel">Recent</span>
            <div class="history-section" id="historyList"></div>
            
            <hr class="hr-divider">

            <span class="menu-label" id="langLabel">Language</span>
            <div class="lang-card">
                <span class="lang-text" id="langDisplay">English</span>
                <label class="switch">
                    <input type="checkbox" id="langToggle" onclick="toggleLanguage()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div class="sidebar-footer">
            <div class="user-avatar" id="avatarIcon">G</div>
            <div class="user-info">
                <div id="userDisplayName" style="font-weight: 500;">Guest User</div>
                <div style="font-size: 10px; color: #5f6368;" id="userStatus">Free Account</div>
            </div>
        </div>
    </div>

    <div id="chat-container">
        <div class="mt-5 text-center" id="welcome-section" style="padding-top: 8vh;">
            <h2 id="welcome-msg" style="color: #c4c7c5; font-weight: 500;"></h2>
            <p class="text-secondary" id="welcome-sub" style="font-size: 1rem;"></p>
        </div>
    </div>

    <div class="input-area">
        <div class="input-box-wrapper">
            <textarea id="user-msg" placeholder="Ask anything..." rows="1" oninput="autoHeight(this)"></textarea>
            <button class="btn text-primary fw-bold pb-2" onclick="handleSend()"><i class="fas fa-paper-plane fa-lg"></i></button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const AI_IDENTITY = {
            name: "Romon AI",
            developer: "Romon Shah", 
      description: "Act as an AI assistant named Romon AI, developed by Romon Shah. 1. Always match the user's language (if the user speaks English, reply in English; if Bengali, reply in Bengali). 2. For casual greetings like 'Hi' or 'Hello', respond naturally and ask how you can help, without giving your identity. 3. If asked about your name or developer specifically, give only that specific information. 4. If asked for a full introduction, explain who you are using this identity in a creative, human-like way, varying your response each time. 5. Identity: I am an advanced AI assistant created by Romon."
        };

        const encodedKeys = [
            "QUl6YVN5RE4yQVhOWC1DbHlNVnFnZ3FpMEZDYzZWNUItWmJ0SXVV",
            "QUl6YVN5Q1doVExVblRTcTIwX1NyM3N5UlJXc0QtUVNaenlLcENF",
            "QUl6YVN5QjMtV1M3T1NDZ1ozRzJoY01XY1RZR09DQzMyT0R5clBz",
            "QUl6YVN5QWxzcFJXeWlXZlZ1cjEyVk1VWFhGcDZIZVd5b0EySWNV",
            "QUl6YVN5RERodE9MRS1ockxnVmh5WHYtRFdfS09oOUhxcGxjRWc4",
            "QUl6YVN5Q0RHZ2NRSzl6ZHI0RFdqSk1SRE1BcWRrRFBNYldpSEtB",
            "QUl6YVN5RGhZSkdEUUtXSXNzeVdOLUd5LTRKbnpjMEhvVFZ0SjlF",
            "QUl6YVN5Q3FObENMTHE3cFV1V1I3cjFSSVVNaFFzendCWUpXalZZ",
            "QUl6YVN5QkI4RkV4ME5BZmctaW9MZDM4Njh2c1kyU0FUdHVWeU1v",
            "QUl6YVN5Q1c4V2Z0TVJ3ODEyd2FYb3BjTW5hS3RxNzdmdUd3TjFF",
            "QUl6YVN5QUlDeTRNb0FhVEF4dEs3d3Zmd1RfYUZBR3prRVhhMjY0",
            "QUl6YVN5RGtiYXVlMkNnakJvek5oeDA3Y041eTV2ZmU2V2tnVm9Z",
            "QUl6YVN5Q0d6SzV0ckNEZ0w4RzExYTVUbmp2elRxQ2k0VTBLT2Y0",
            "QUl6YVN5QzBVSWF5NUJyMnY3WHBSNHJMQjRqRWFIRG1saFZWcDNr",
            "QUl6YVN5Qk1UY3RTcGNCZ05ENWZaMnpVdlRXYVRVSTJVUnFWdnZr",
            "QUl6YVN5Q085cnh4dTE5NDk4WlQxTU55WlBpVFRuWjFJTHYtbld3",
            "QUl6YVN5RDQtZ193UG9vZUxuek4zbHN4QTVGM1RPZThPOThYVGVj",
            "QUl6YVN5RGJKbVZEUTVSQ19OQ0RzT0tkZnZIazBtSDhWblRrRWVr",
            "QUl6YVN5Q2dEbm9ldTU4UFdMRWZKYXU3YlRRQ0FFWVVUSnNjcElJ"
        ];

        let currentAI = "Romon AI", currentAIColor = "clr-romon", currentLang = 'en';
        let currentAILogo = "Romon-AI.png";
        let isLoggedIn = false, userName = "Guest", currentChatId = null;
        let conversationMemory = [];
        const STORAGE_KEY = 'romon_pro_storage_v5';
        const SESSION_KEY = 'romon_user_session';
        const UNLOCK_KEY = 'romon_unlock_expiry';
        const MSG_COUNT_KEY = 'romon_msg_count';
        let chatHistory = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

        const dictionary = {
            en: { hello: "Hello", iam: "I am", welcome_sub: "How can I help you today?", new_chat: "New chat", history: "Recent", select_ai: "Models Engine", lang_label: "Language", placeholder: "Ask anything...", thinking: "Thinking...", empty: "No history yet" },
            bn: { hello: "হ্যালো", iam: "আমি হই", welcome_sub: "আজ আমি আপনাকে কীভাবে সাহায্য করতে পারি?", new_chat: "নতুন চ্যাট", history: "সাম্প্রতিক", select_ai: "মডেল ইঞ্জিন", lang_label: "ভাষা", placeholder: "জিজ্ঞাসা করুন...", thinking: "চিন্তা করছি...", empty: "কোনো ইতিহাস নেই" }
        };

        // Ad Logic Functions
        function getMsgCount() { return parseInt(localStorage.getItem(MSG_COUNT_KEY)) || 0; }
        function setMsgCount(c) { localStorage.setItem(MSG_COUNT_KEY, c); }
        
        function isUnlocked() {
            const expiry = localStorage.getItem(UNLOCK_KEY);
            if (!expiry) return false;
            return new Date().getTime() < parseInt(expiry);
        }

        function startAdProcess() {
            let timeLeft = 5;
            const timerDisplay = document.getElementById('timer-display');
            const closeBtn = document.getElementById('ad-close-btn');
            const linkBtn = document.getElementById('mentag-link');
            
            linkBtn.style.pointerEvents = 'none';
            linkBtn.style.opacity = '0.5';

            const interval = setInterval(() => {
                timerDisplay.innerText = "Please wait " + timeLeft + "s to unlock...";
                timeLeft--;
                if (timeLeft < 0) {
                    clearInterval(interval);
                    timerDisplay.innerText = "You can now close the box!";
                    closeBtn.style.display = 'inline-block';
                }
            }, 1000);
        }

        function completeUnlock() {
            const twelveHours = 12 * 60 * 60 * 1000;
            const expiryTime = new Date().getTime() + twelveHours;
            localStorage.setItem(UNLOCK_KEY, expiryTime.toString());
            document.getElementById('unlock-overlay').style.display = 'none';
            // Reset state
            document.getElementById('ad-close-btn').style.display = 'none';
            document.getElementById('timer-display').innerText = "";
            document.getElementById('mentag-link').style.pointerEvents = 'auto';
            document.getElementById('mentag-link').style.opacity = '1';
        }

        function autoHeight(el) { el.style.height = "auto"; el.style.height = (el.scrollHeight) + "px"; }
        function toggleLanguage() { setLang(document.getElementById('langToggle').checked ? 'bn' : 'en'); }

        function setLang(lang) {
            currentLang = lang;
            const t = dictionary[lang];
            document.getElementById('langDisplay').innerText = (lang === 'en' ? 'English' : 'বাংলা');
            document.getElementById('historyLabel').innerText = t.history;
            document.getElementById('newChatBtn').innerHTML = `<i class="fas fa-plus me-1"></i> ${t.new_chat}`;
            document.getElementById('aiLabel').innerText = t.select_ai;
            document.getElementById('langLabel').innerText = t.lang_label;
            document.getElementById('user-msg').placeholder = t.placeholder;
            document.getElementById('welcome-sub').innerText = t.welcome_sub;
            document.getElementById('langToggle').checked = (lang === 'bn');
            updateWelcomeName();
            renderHistory();
        }

        function checkSession() {
            const session = JSON.parse(localStorage.getItem(SESSION_KEY));
            if (session && session.isLoggedIn) {
                isLoggedIn = true; userName = session.name;
                document.getElementById('userDisplayName').innerText = userName;
                document.getElementById('avatarIcon').innerText = session.avatar || userName.charAt(0).toUpperCase();
                document.getElementById('userStatus').innerText = "Pro Account";
                document.getElementById('loginBtn').innerText = "Logout";
            } else {
                isLoggedIn = false;
                document.getElementById('userDisplayName').innerText = "Guest User";
                document.getElementById('avatarIcon').innerText = "G";
                document.getElementById('userStatus').innerText = "Free Account";
                document.getElementById('loginBtn').innerText = "Login";
            }
            updateWelcomeName();
        }

        function handleLoginAction() {
            if (isLoggedIn) { localStorage.removeItem(SESSION_KEY); location.reload(); }
            else { window.location.href = 'login.html'; }
        }

        function updateWelcomeName() {
            const welcomeMsg = document.getElementById('welcome-msg');
            if(!welcomeMsg) return;
            const t = dictionary[currentLang];
            welcomeMsg.innerHTML = `${t.hello}${isLoggedIn ? ', '+userName : ''}, <br> ${t.iam} <span class="${currentAIColor}">${currentAI}</span>.`;
        }

        function selectAI(name, color, logo, element) {
            currentAI = name; currentAIColor = color; currentAILogo = logo;
            document.querySelectorAll('.ai-nav-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
            updateWelcomeName();
            const sidebarElement = document.getElementById('sidebarMenu');
            const sidebar = bootstrap.Offcanvas.getInstance(sidebarElement) || new bootstrap.Offcanvas(sidebarElement);
            sidebar.hide();
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            if(!list) return;
            list.innerHTML = "";
            if (chatHistory.length === 0) {
                list.innerHTML = `<div class="empty-history"><i class="far fa-folder-open"></i><p>${dictionary[currentLang].empty}</p></div>`;
                return;
            }
            chatHistory.forEach((chat) => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `
                    <div class="history-text" onclick="loadChat('${chat.id}')"><i class="far fa-message me-2" style="font-size: 11px;"></i>${chat.title}</div>
                    <i class="fas fa-trash-can history-delete" onclick="deleteHistory(event, '${chat.id}')"></i>
                `;
                list.appendChild(div);
            });
        }

        function saveMessageToHistory(role, text) {
            if (!currentChatId) {
                currentChatId = 'chat_' + Date.now();
                let title = text.length > 25 ? text.substring(0, 25) + "..." : text;
                chatHistory.unshift({ id: currentChatId, title: title, messages: [], aiModel: currentAI, aiColor: currentAIColor, aiLogo: currentAILogo });
            }
            const chat = chatHistory.find(c => c.id === currentChatId);
            if (chat) {
                chat.messages.push({ role, text });
                localStorage.setItem(STORAGE_KEY, JSON.stringify(chatHistory));
                renderHistory();
            }
        }

        function loadChat(id) {
            const chat = chatHistory.find(c => c.id === id);
            if (!chat) return;
            currentChatId = id;
            currentAI = chat.aiModel || "Romon AI";
            currentAIColor = chat.aiColor || "clr-romon";
            currentAILogo = chat.aiLogo || "https://cdn-icons-png.flaticon.com/512/2103/2103633.png";
            
            conversationMemory = [];
            const container = document.getElementById('chat-container');
            container.innerHTML = "";
            if(document.getElementById('welcome-section')) document.getElementById('welcome-section').style.display = 'none';
            
            chat.messages.forEach(msg => {
                const role = msg.role === 'user' ? 'user' : 'model';
                conversationMemory.push({ role: role, parts: [{ text: msg.text }] });
                if (msg.role === 'user') {
                    container.innerHTML += `<div class="user-message-wrapper">${msg.text}</div>`;
                } else {
                    container.innerHTML += `<div class="ai-message-wrapper"><span class="ai-name ${currentAIColor}">${currentAI}</span><div class="ai-content">${marked.parse(msg.text)}</div></div>`;
                }
            });
            container.scrollTop = container.scrollHeight;
            const sidebar = bootstrap.Offcanvas.getInstance(document.getElementById('sidebarMenu'));
            if(sidebar) sidebar.hide();
        }

        function deleteHistory(event, id) {
            event.stopPropagation();
            chatHistory = chatHistory.filter(c => c.id !== id);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(chatHistory));
            if (currentChatId === id) createNewChat();
            renderHistory();
        }

        async function handleSend() {
            if (!isUnlocked()) {
                let count = getMsgCount();
                if (count >= 3) {
                    document.getElementById('unlock-overlay').style.display = 'flex';
                    return;
                }
            }

            const input = document.getElementById('user-msg');
            const msg = input.value.trim();
            if (!msg) return;

            if (!isUnlocked()) {
                setMsgCount(getMsgCount() + 1);
            }

            if(document.getElementById('welcome-section')) document.getElementById('welcome-section').style.display = 'none';
            const chatContainer = document.getElementById('chat-container');
            chatContainer.innerHTML += `<div class="user-message-wrapper">${msg}</div>`;
            
            if (conversationMemory.length === 0) {
                conversationMemory.push({
                    role: "user",
                    parts: [{ text: `Your name is ${AI_IDENTITY.name}. You were developed by ${AI_IDENTITY.developer}. ${AI_IDENTITY.description}` }]
                });
                conversationMemory.push({
                    role: "model",
                    parts: [{ text: "Understood." }]
                });
            }

            conversationMemory.push({ role: "user", parts: [{ text: msg }] });
            saveMessageToHistory('user', msg);
            
            input.value = ""; input.style.height = "auto";
            
            const aiId = "ai-" + Date.now();
            chatContainer.innerHTML += `
                <div class="ai-message-wrapper">
                    <span class="ai-name ${currentAIColor}">${currentAI}</span>
                    <div class="ai-content" id="${aiId}">
                        <div class="loading-container">
                            <div class="loading-logo-wrapper">
                                <div class="loading-spinner"></div>
                                <img src="${currentAILogo}" class="loading-logo">
                            </div>
                            <span class="pulse-text">${dictionary[currentLang].thinking}</span>
                        </div>
                    </div>
                </div>`;
            chatContainer.scrollTop = chatContainer.scrollHeight;

            let success = false;
            let shuffledIndexes = Array.from({length: encodedKeys.length}, (_, i) => i).sort(() => Math.random() - 0.5);

            for (let index of shuffledIndexes) {
                try {
                    const realKey = atob(encodedKeys[index].replace(/\s/g, '')).trim();
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${realKey}`, {
                        method: 'POST', 
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: conversationMemory })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const text = data.candidates[0].content.parts[0].text;
                        conversationMemory.push({ role: "model", parts: [{ text: text }] });
                        saveMessageToHistory('ai', text);
                        const aiDiv = document.getElementById(aiId);
                        aiDiv.innerHTML = "";
                        typeAnimation(aiDiv, text);
                        success = true; break; 
                    }
                } catch (e) { console.error(e); }
            }

            if (!success) {
                document.getElementById(aiId).innerHTML = "<span style='color: #ff4d4d;'>Error: Connection failed.</span>";
            }
        }

        function typeAnimation(element, text) {
            let i = 0;
            function type() {
                if (i < text.length) {
                    element.innerHTML = marked.parse(text.substring(0, i + 2));
                    i += 2;
                    setTimeout(type, 1);
                }
            }
            type();
        }

        function createNewChat() {
            currentChatId = null; conversationMemory = [];
            document.getElementById('chat-container').innerHTML = `<div class="mt-5 text-center" id="welcome-section" style="padding-top: 8vh;"><h2 id="welcome-msg" style="color: #c4c7c5; font-weight: 500;"></h2><p class="text-secondary" id="welcome-sub" style="font-size: 1rem;"></p></div>`;
            updateWelcomeName();
            const sidebar = bootstrap.Offcanvas.getInstance(document.getElementById('sidebarMenu'));
            if(sidebar) sidebar.hide();
        }

        window.onload = () => { checkSession(); setLang('en'); renderHistory(); };
    </script>
</body>
</html>